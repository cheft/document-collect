<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
html { font-size: 100%; overflow-y: scroll; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }

body{
  color:#444;
  font-family:Georgia, Palatino, 'Palatino Linotype', Times, 'Times New Roman',
              "Hiragino Sans GB", "STXihei", "微软雅黑", serif;
  font-size:12px;
  line-height:1.5em;
  background:#fefefe;
  width: 45em;
  margin: 10px auto;
  padding: 1em;
  outline: 1300px solid #FAFAFA;
}

a{ color: #0645ad; text-decoration:none;}
a:visited{ color: #0b0080; }
a:hover{ color: #06e; }
a:active{ color:#faa700; }
a:focus{ outline: thin dotted; }
a:hover, a:active{ outline: 0; }

span.backtick {
  border:1px solid #EAEAEA;
  border-radius:3px;
  background:#F8F8F8;
  padding:0 3px 0 3px;
}

::-moz-selection{background:rgba(255,255,0,0.3);color:#000}
::selection{background:rgba(255,255,0,0.3);color:#000}

a::-moz-selection{background:rgba(255,255,0,0.3);color:#0645ad}
a::selection{background:rgba(255,255,0,0.3);color:#0645ad}

p{
margin:1em 0;
}

img{
max-width:100%;
}

h1,h2,h3,h4,h5,h6{
font-weight:normal;
color:#111;
line-height:1em;
}
h4,h5,h6{ font-weight: bold; }
h1{ font-size:2.5em; }
h2{ font-size:2em; border-bottom:1px solid silver; padding-bottom: 5px; }
h3{ font-size:1.5em; }
h4{ font-size:1.2em; }
h5{ font-size:1em; }
h6{ font-size:0.9em; }

blockquote{
color:#666666;
margin:0;
padding-left: 3em;
border-left: 0.5em #EEE solid;
}
hr { display: block; height: 2px; border: 0; border-top: 1px solid #aaa;border-bottom: 1px solid #eee; margin: 1em 0; padding: 0; }


pre , code, kbd, samp { 
  color: #000; 
  font-family: monospace; 
  font-size: 0.88em; 
  border-radius:3px;
  background-color: #F8F8F8;
  border: 1px solid #CCC; 
}
pre { white-space: pre; white-space: pre-wrap; word-wrap: break-word; padding: 5px 12px;}
pre code { border: 0px !important; padding: 0;}
code { padding: 0 3px 0 3px; }

b, strong { font-weight: bold; }

dfn { font-style: italic; }

ins { background: #ff9; color: #000; text-decoration: none; }

mark { background: #ff0; color: #000; font-style: italic; font-weight: bold; }

sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }

ul, ol { margin: 1em 0; padding: 0 0 0 2em; }
li p:last-child { margin:0 }
dd { margin: 0 0 0 2em; }

img { border: 0; -ms-interpolation-mode: bicubic; vertical-align: middle; }

table { border-collapse: collapse; border-spacing: 0; }
td { vertical-align: top; }

@media only screen and (min-width: 480px) {
body{font-size:14px;}
}

@media only screen and (min-width: 768px) {
body{font-size:16px;}
}

@media print {
  * { background: transparent !important; color: black !important; filter:none !important; -ms-filter: none !important; }
  body{font-size:12pt; max-width:100%; outline:none;}
  a, a:visited { text-decoration: underline; }
  hr { height: 1px; border:0; border-bottom:1px solid black; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; padding-right: 1em; page-break-inside: avoid; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page :left { margin: 15mm 20mm 15mm 10mm; }
  @page :right { margin: 15mm 10mm 15mm 20mm; }
  p, h2, h3 { orphans: 3; widows: 3; }
  h2, h3 { page-break-after: avoid; }
}
  
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
<title>归档服务程序部署文档</title>

</head>
<body>
<h1>归档服务程序部署文档</h1>

<hr />

<h2>ASP.NET Server端部署</h2>

<blockquote><p>要求服务器环境为windows Server 2003，装有安装版Office 2003而非绿色版，安装好IIS 6.0</p></blockquote>

<h3>IIS 部署</h3>

<blockquote><p>打开IIS管理器</p></blockquote>

<p><img src="images/01.jpg" alt="Alt " /></p>

<blockquote><p>右键添加网站</p></blockquote>

<p><img src="images/02.jpg" alt="Alt " /></p>

<blockquote><p>为网站取名，例如：CollectService</p></blockquote>

<p><img src="images/03.jpg" alt="Alt " /></p>

<blockquote><p>绑定端口，例如：12333</p></blockquote>

<p><img src="images/04.jpg" alt="Alt " /></p>

<blockquote><p>将网站主目录指向归档服务程序的物理目录(归档服务程序由开发人员提供)</p></blockquote>

<p><img src="images/05.jpg" alt="Alt " /></p>

<blockquote><p>设定网站访问权限</p></blockquote>

<p><img src="images/06.jpg" alt="Alt " /></p>

<blockquote><p>左键属性(Properties)查看此网站所用的应用程序池是什么，这里为 <strong><em>DefaultAppPool</em></strong></p></blockquote>

<p><img src="images/07.jpg" alt="Alt " /></p>

<p><img src="images/08.jpg" alt="Alt " /></p>

<blockquote><p>那么就去查看DefaultAppPool应用程序池的标识是否为 <strong><em>网络服务(NetworkService)</em></strong>，若不是，请改成它</p></blockquote>

<p><img src="images/09.jpg" alt="Alt " /></p>

<p><img src="images/10.jpg" alt="Alt " /></p>

<h3>权限配置</h3>

<ul>
<li>因为IIS调用Office com组件需要配置权限，否则就会引发错误：检索 COM 类工厂中 CLSID 为 {000209FF-0000-0000-C000-000000000046} 的组件时失败，原因是出现以下错误: 80070005。 请按以下方法配置权限：</li>
</ul>


<blockquote><p>win + R快捷键 打开运行命令框，敲入 mmc -32，进入控制台</p></blockquote>

<p><img src="images/11.jpg" alt="Alt " /></p>

<blockquote><p>点击 增加/删除管理单元</p></blockquote>

<p><img src="images/12.jpg" alt="Alt " /></p>

<blockquote><p>增加 组件服务</p></blockquote>

<p><img src="images/13.jpg" alt="Alt " /></p>

<blockquote><p>依次双击"组件服务"->"计算机"->"我的电脑"->"DCOM配置" 找到与word相关的组件，右键属性</p></blockquote>

<p><img src="images/14.jpg" alt="Alt " /></p>

<blockquote><p><strong><em>常规</em></strong> 中可以确认本地路径是以WINWORD.EXE 结尾的</p></blockquote>

<p><img src="images/15.jpg" alt="Alt " /></p>

<blockquote><p>点击 <strong><em>标识</em></strong> 标签,选择 <strong><em>下列用户</em></strong>，填写本机用户及密码</p></blockquote>

<p><img src="images/16.jpg" alt="Alt " /></p>

<blockquote><p>点击 <strong><em>安全(Security)</em></strong> 标签,在 <strong><em>启动和激活权限(Launch and Activation Permissions)</em></strong> 上点击 <strong><em>自定义(Customerize)</em></strong> ,</p></blockquote>

<p><img src="images/17.jpg" alt="Alt " /></p>

<blockquote><p>点击对应的<strong><em>编辑(Edit)</em></strong>按钮,在弹出的 <strong><em>安全性</em></strong> 对话框中点击添加</p></blockquote>

<p><img src="images/18.jpg" alt="Alt " /></p>

<blockquote><p>注意 <strong><em>查找位置</em></strong> 要选择本计算机，填入 <strong><em>NETWORK SERVICE</em></strong> 点击确定增加此用户</p></blockquote>

<p> <img src="images/19.jpg" alt="Alt " /></p>

<blockquote><p>赋予 NETWORK SERVICE <strong><em>本地启动（Local Launch)</em></strong> 等所有权限；</p></blockquote>

<p>同时在 <strong><em>访问权限(Access Permissions)</em></strong> 、<strong><em>配置权限(Configuration Permissions)</em></strong> 选项上也要做同样操作，点击 <strong><em>自定义</em></strong> ,然后点击"编辑",在弹出的"安全性"对话框中也填加一个"NETWORK SERVICE"用户,也赋予所有权限.</p>

<p><img src="images/20.jpg" alt="Alt " /></p>

<blockquote><p>刚刚仅把word相关组件配置了权限，另外还有Excel、PPT相关的组件需要设置，请依次找到进行相同的操作</p>

<p>下图标记出Excel和Word组件，在所有的组件中没有找到PPT的，于是在花时间在后面的UUID的组件中，才找到关于PPT的组件，这里需要根据本地路径来寻找， 以POWERPNT.EXE结尾。(根据安装的office和windows不同会有不同情况，需要特别注意一下，万一找不到就需要去UUID的组件中找路径相关的，Word组件是以 WINWORD.EXE结尾，Excel组件是以 EXCEL.EXE结尾，PPT组件是以POWERPNT结尾 )</p></blockquote>

<p><img src="images/21.jpg" alt="Alt " /></p>

<p><img src="images/22.jpg" alt="Alt " /></p>

<h3>归档服务程序配置</h3>

<blockquote><p>创建归档服务需要的临时目录，可以为任意目录，比如选择 <strong><em>D:\topway\collect</em></strong> 下创建这四个文件夹 <strong><em>document, request, log, temp</em></strong> ，右键 <strong><em>D:\topway\collect</em></strong> 目录 <strong><em>属性</em></strong> ，选择 <strong><em>安全</em></strong> 标签，点击 <strong><em>编辑</em></strong> ,在弹出的对话框中添加 <strong><em>NETWORK SERVICE</em></strong> 用户 然后赋予 <strong><em>完全控制</em></strong> 的权限.</p></blockquote>

<p><img src="images/23.jpg" alt="Alt " /></p>

<p><img src="images/24.jpg" alt="Alt " /></p>

<p><img src="images/25.jpg" alt="Alt " /></p>

<blockquote><p>修改归档服务程序中的web.config 配置文件： 找到 <em>QueueDir</em> 的value，及 <em>LogFileAppender file</em> 的value，修改如下图：</p></blockquote>

<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;appSettings&gt;</span>
    <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;QueueDir&quot;</span><span class="ot"> value=</span><span class="st">&quot;D:\topway\collect&quot;</span><span class="kw">/&gt;</span> <span class="co">&lt;!-- 队列目录 --&gt;</span>
    <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;QueueInterval&quot;</span><span class="ot"> value=</span><span class="st">&quot;3000&quot;</span><span class="kw">/&gt;</span>         <span class="co">&lt;!-- 队列循环间隔时间 --&gt;</span>
    <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;IsSheet&quot;</span><span class="ot"> value=</span><span class="st">&quot;1&quot;</span><span class="kw">/&gt;</span>                  <span class="co">&lt;!-- Excel是否切割Sheet页 --&gt;</span>
    <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;IsImage&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">/&gt;</span>            <span class="co">&lt;!-- Word, Excel是否图片模式，需要office2007及以上 --&gt;</span>
    <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;JavaServerOn&quot;</span><span class="ot"> value=</span><span class="st">&quot;0&quot;</span><span class="kw">/&gt;</span>     <span class="co">&lt;!--是否向客户端传回转换日志--&gt;</span>
    <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;JavaServerUrl&quot;</span><span class="ot"> value=</span><span class="st">&quot;http://172.18.97.60:8080/Project/ServletUrl&quot;</span><span class="kw">/&gt;</span>  <span class="co">&lt;!--客户端传回转换日志请求地址--&gt;</span>
<span class="kw">&lt;/appSettings&gt;</span>
<span class="kw">&lt;log4net&gt;</span>
    <span class="co">&lt;!--定义日志输出到文件中--&gt;</span>
    <span class="kw">&lt;appender</span><span class="ot"> name=</span><span class="st">&quot;LogFileAppender&quot;</span><span class="ot"> type=</span><span class="st">&quot;log4net.Appender.FileAppender&quot;</span><span class="kw">&gt;</span>
      <span class="co">&lt;!--定义日志文件存放位置--&gt;</span>
      <span class="kw">&lt;file</span><span class="ot"> value=</span><span class="st">&quot;D:\topway\collect\log\DocumentService.log&quot;</span><span class="kw">/&gt;</span>
      <span class="kw">&lt;appendToFile</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span><span class="kw">/&gt;</span>
      <span class="kw">&lt;rollingStyle</span><span class="ot"> value=</span><span class="st">&quot;Date&quot;</span><span class="kw">/&gt;</span>

<span class="co">&lt;!-- 省略 --&gt;</span>
<span class="kw">&lt;/log4net&gt;</span></code></pre>

<h2>IIS配置注意</h2>

<pre><code>部署好CollectService服务，右键 DocumentWebServcie.asmx 页面浏览，若浏览器没有显示或显示出错，请按下图配置
</code></pre>

<p><img src="images/31.png" alt="Alt " /></p>

<pre><code>若操作系统为 server 2008 64位，请按下图配置 启动32位应用程序
</code></pre>

<p><img src="images/32.jpg" alt="Alt " /></p>

<pre><code>若操作系统为 server 2003 64位，请安以下步骤配置

*单击“开始”，单击“运行”，键入 cmd，然后单击“确定”。

*键入以下命令启用 32 位模式：
cscript %SYSTEMDRIVE%\inetpub\adminscripts\adsutil.vbs SET W3SVC/AppPools/Enable32bitAppOnWin64 1

*键入以下命令，安装 ASP.NET 2.0（32 位）版本并在 IIS 根目录下安装脚本映射：
%SYSTEMROOT%\Microsoft.NET\Framework\v2.0.40607\aspnet_regiis.exe -i

*确保在 Internet 信息服务管理器的 Web 服务扩展列表中，将 ASP.NET 版本 2.0.40607（32 位）的状态设置为允许。
</code></pre>

<p><img src="images/31.png" alt="Alt " /></p>
</body>
</html>